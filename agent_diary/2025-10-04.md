# 2025-10-04

## Focus
Extend evaluation outputs for richer portfolio diagnostics and introduce an algorithm-agnostic project epoch cadence for training/evaluation.

## Progress
- Updated evaluation trace writer to capture cash, per-symbol holdings, daily portfolio value changes, and export final evaluation episodes under `final_eval_traces/`, refreshing tests to assert the CSV schema (`src/pipelines/training.py`, `tests/test_training_pipeline.py`).
- Implemented project epoch infrastructure: tracker, progress/evaluation/checkpoint callbacks, and unified metric logging (`project_epoch`, `total_env_steps`, `episodes_completed`, `updates_applied`, `wall_time`), plus algorithm metadata extraction for PPO/on-policy vs off-policy comparability (`src/pipelines/training.py`).
- Added config resolution helpers and documentation describing the new cadence, ensuring legacy `*_epochs`/`*_freq` options map cleanly to project epochs and recording the behavior in the architecture notes (`src/pipelines/training.py`, `docs/architecture.md`).
- Delivered deterministic evaluation tooling: `scripts/evaluate.py` runs checkpoint rollouts (with optional stress multipliers) and `scripts/report.py` aggregates metrics/traces into CSV/JSON summaries (`src/pipelines/evaluation.py`, `scripts/evaluate.py`, `scripts/report.py`).
- Finalised off-policy presets and stress hooks, extending `EnvironmentConfig` and configs with commission/slippage multipliers plus richer logging metrics (`src/env/multi_stock_env.py`, `src/utils/builders.py`, `configs/base.yaml`, `configs/full_training.yaml`).
- Reworked the environment transaction policy to charge commission+slippage on sells only, removed buy-side fees, and now emit nav/turnover/drawdown so project-epoch metrics capture portfolio diagnostics out of the box (`src/env/multi_stock_env.py`, `src/pipelines/training.py`).
- Verified pipeline behavior via targeted pytest on the training suite to confirm logging, CSV outputs, and cadence transitions (`python -m pytest tests/test_training_pipeline.py::test_run_training_pipeline`).

## Findings & Decisions
- Project epochs default to per-step cadence but can switch to episode or wall-time units without touching SB3 internals, making the scheduler consistent across PPO/SAC/DDPG.
- Metrics CSV now records nav/turnover/drawdown directly from the environment, simplifying downstream performance analysis, and the new report script surfaces them in a single summary.
- Stress multipliers enable quick slippage/commission what-if evaluation without code changes (via config or CLI arguments).

## Next Steps
1. Extend reporting to compute richer analytics (Sharpe, downside deviation, volatility) on evaluation outputs.
2. Capture git commit hashes and runtime metadata alongside future runs.
3. Prepare hyperparameter sweep utilities and document recommended search spaces for PPO/SAC, then explore additional stress scenarios (turbulence halts).

## Summary
- Sells now pay commission and slippage while buys remain fee-free; nav/turnover/drawdown surface in `info` and flow through project-epoch metrics.
- Evaluation/report tooling (`scripts/evaluate.py`, `scripts/report.py`) now produces JSON/CSV summaries and stress-aware traces for checkpoints.
- Project-epoch logging ingests the new diagnostics automatically, and docs/configs were updated to reflect the policy shift.
