# 2025-10-08 — Daily Log (KST)

Note on time: Local timezone is KST (UTC+9). If any API/system clock diverges from this date, annotate it in logs and avoid using non-KST timestamps for decisions/diaries.

## Focus
- Produce a single canonical dataset with embedded hybrid turbulence signals and wire a regime-aware safety layer into the environment, with train/valid visualizations.

## Plan
1) Data: integrate investor ratios + compute turb_port (subset) and turb_sys (system) → embed into final CSV.
2) Env: add regime safety (g_max ramping, per-asset cap, buy-freeze in crisis, L1 throttles).
3) Viz: when validation improves, save validation and training traces/plots; overlay turbulence and throttle markers.
4) Tests: keep unit/integration green; run a 2‑epoch debug training to validate logging/emissions.

## KPIs
- Final CSV contains `turb_port`, `turb_sys` and they are not identical over the evaluation horizon.
- Safety diagnostics exposed in traces: `q_port`, `q_sys`, `regime`, `g_max`, throttle flags.
- 2‑epoch debug completes with train/valid traces and valuation plots.
- Test suite passes (>= 30 tests).

## Checklist
- [x] Build hybrid turbulence (subset/system) and embed into `data/proc/daily_with_indicators.csv`.
- [x] Add SafetyConfig and regime logic (hysteresis, g_max ramping, per-asset cap, buy-freeze, L1 throttles).
- [x] Extend evaluation traces with turbulence/safety diagnostics; overlay turbulence and throttle markers on NAV plots.
- [x] Save train-split traces/plots when validation hits a new best.
- [x] Update configs (base/debug/full) with safety knobs; add turbulence columns to schema.
- [x] Tests green; 2‑epoch debug run emits expected artifacts.

## Summarize (What shipped)
- Data: One-shot CLI writes a single final CSV with `turb_port` and `turb_sys`. If KIS is unavailable, falls back to FDR for system returns.
- Env: Regime-based safety layer clamps exposure and execution during high turbulence; info() logs all signals and throttle hits.
- Viz: NAV plots annotate turbulence (turb_sys on twin axis) and throttle spans; train-split plots are stored only on validation improvement.
- Quality: Test suite passes (32/32). Debug runs populate traces with turbulence/safety fields.

## Commands (for reproducibility)
1) Build master (FDR fallback): `data/raw/kis/master_kospi.csv`.
2) Build final with embedded turbulence: `python -m scripts.build_data --raw-clean-csv data/proc/daily_raw_clean.from_orig.csv --kis-master data/raw/kis/master_kospi.csv --sys-max-symbols 120 --env real --out-csv data/proc/daily_with_indicators.csv`.
3) Debug training (2‑epoch): `python -m scripts.train --config configs/debug_two_epoch.yaml --run-name safety_smoke --algo PPO`.

## Notes
- KIS vs system clock: Keep KST in diaries/logs. If API uses UTC or another TZ, normalize to KST before logging.
